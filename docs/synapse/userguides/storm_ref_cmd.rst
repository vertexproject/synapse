



.. _storm-ref-cmd:

Storm Reference - Storm Commands
================================

Storm commands are built-in or custom commands that can be used with the Synapse :ref:`syn-storm` command itself. As such, Storm commands must be executed following the ``storm`` command:

**storm** *<command>*

or

**storm** *<query>* **|** *<command>* [ **|** *<query>* ]

The pipe symbol ( ``|`` ) is used to send (pipe) the output from a Storm query to any of the Storm commands, and to send the output from a Storm command back to a Storm query.

**Built-in commands** are native to the Storm library and loaded by default within a given Cortex. Built-in commands comprise a set of helper commands that perform a variety of specialized tasks that are useful regardless of the types of data stored in the Cortex or the types of analysis performed.

**Custom commands** are Storm commands that have been added to a Cortex to invoke the execution of dynamically loaded modules. Dynamically loaded modules are typically custom modules that have been added to Synapse to support domain-specific analysis. For example, a knowledge domain that requires tracking of IP addresses might have access to a third-party service such as Maxmind to obtain up-to-date data on the assigned Autonomous System (AS) or geographical location of a given IP address. A custom ``maxmind`` module and associated Storm command could be added to Synapse to query the Maxmind database and update the appropriate secondary properties on the associated ``inet:ipv4`` nodes directly from Storm.

The full list of storm commands (built-in and custom) available in a given Cortex can be displayed with ``storm help``.

Help for a specific Storm command can be displayed with ``storm <command> --help``.

This section details the usage and syntax for built-in Storm commands:

- `help`_
- `count`_
- `delnode`_
- `graph`_
- `iden`_
- `limit`_
- `max`_
- `min`_
- `movetag`_
- `noderefs`_
- `reindex`_
- `sleep`_
- `spin`_
- `sudo`_
- `uniq`_

See :ref:`storm-ref-syntax` for an explanation of the syntax format used below.

The Storm query language is covered in detail starting with the :ref:`storm-ref-intro` section of the Synapse User Guide.

.. _storm-help:

help
----

The ``help`` command (``storm help``) displays the list of available built-in commands and a brief message describing each command. Help on individual commands is available via ``<command> --help``.

**Syntax:**



.. parsed-literal::

    cli> storm help
    
    count: Iterate through query results, and print the resulting number of nodes
    delnode: Delete nodes produced by the previous query logic.
    graph: Generate a subgraph from the given input nodes and command line options.
    help: List available commands and a brief description for each.
    iden: Lift nodes by iden.
    limit: Limit the number of nodes generated by the query in the given position.
    max: Consume nodes and yield only the one node with the highest value for a property.
    min: Consume nodes and yield only the one node with the lowest value for a property.
    movetag: Rename an entire tag tree and preserve time intervals.
    noderefs: Get nodes adjacent to inbound nodes, up to n degrees away.
    reindex: Use admin privileges to re index/normalize node properties.
    sleep: Introduce a delay between returning each result for the storm query.
    spin: Iterate through all query results, but do not yield any.
    sudo: Use admin privileges to bypass standard query permissions.
    uniq: Filter nodes by their uniq iden values.
    
    For detailed help on any command, use <cmd> --help
    complete. 0 nodes in 2 ms (0/sec).


.. _storm-count:

count
-----

The ``count`` command enumerates the number of nodes returned from a given Storm query and displays the resultant nodes and associated node count.

** Syntax **


.. parsed-literal::

    cli> storm count --help
    
    usage: count [-h]
    
        Iterate through query results, and print the resulting number of nodes
        which were lifted. This does yield the nodes counted.
    
        Example:
    
            foo:bar:size=20 | count
    
        
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 4 ms (0/sec).


**Examples:**

*Count the number of email address nodes:*



.. parsed-literal::

    inet:email | count


*Count the number of DNS A records in the Cortex for the domain woot.com:*



.. parsed-literal::

    inet:dns:a:fqdn=woot.com | count


**Usage Notes:**

- ``count`` does not consume nodes, so Storm will stream the nodes being counted to the CLI output while the command executes. To count nodes without streaming the output, ``count`` can be piped to the `spin`_ command. ``Spin`` consumes nodes and so will prevent nodes processed by the ``count`` command from streaming.

.. _storm-delnode:

delnode
-------

The ``delnode`` command deletes a node or set of nodes from a Cortex.

.. WARNING::
  The Storm ``delnode`` command has the potential to be destructive if executed on an incorrect, badly formed, or mistyped query. Users are strongly encouraged to validate their query by first executing it on its own to confirm it returns the expected nodes before piping the query to the ``delnode`` command.

**Syntax:**



.. parsed-literal::

    cli> storm delnode --help
    
    usage: delnode [-h] [--force]
    
        Delete nodes produced by the previous query logic.
    
        (no nodes are returned)
    
        Example
    
            inet:fqdn=vertex.link | delnode
        
    
    optional arguments:
      -h, --help  show this help message and exit
      --force     Force delete even if it causes broken references (requires
                  admin).
    
    complete. 0 nodes in 5 ms (0/sec).


**Examples:**

*Delete the node for the domain woowoo.com:*



.. parsed-literal::

    inet:fqdn=woowoo.com | delnode


*Forcibly delete all nodes with the #testing tag:*


.. parsed-literal::

    #testing | delnode --force


**Usage Notes:**

- ``delnode`` operates on the output of a previous Storm query.
- ``delnode`` will attempt to perform some basic sanity-checking to help prevent egregious mistakes. For example, ``delnode`` will return an error if you attempt to delete a node that is still referenced by another node (such as an ``inet:fqdn`` that is referenced by an ``inet:dns:a`` node). Similarly, delnode will return an error if you attempt to delete a ``syn:tag`` node if that tag is still applied to other nodes. **However, delnode cannot prevent all mistakes.**
- The ``--force`` parameter will forcibly delete the nodes input to the command, regardless of any sanity-checking errors or other conditions. **This parameter should be used with extreme caution.**

.. _storm-graph:

graph
-----

The ``graph`` command generates a subgraph based on a specified set of nodes and parameters.

**Syntax:**



.. parsed-literal::

    cli> storm graph --help
    
    usage: graph [-h] [--degrees DEGREES] [--pivot PIVOT] [--filter FILTER]
                 [--form-pivot FORM_PIVOT FORM_PIVOT]
                 [--form-filter FORM_FILTER FORM_FILTER]
    
        Generate a subgraph from the given input nodes and command line options.
        
    
    optional arguments:
      -h, --help            show this help message and exit
      --degrees DEGREES     How many degrees to graph out.
      --pivot PIVOT         Specify a storm pivot for all nodes. (must quote)
      --filter FILTER       Specify a storm filter for all nodes. (must quote)
      --form-pivot FORM_PIVOT FORM_PIVOT
                            Specify a <form> <pivot> form specific pivot.
      --form-filter FORM_FILTER FORM_FILTER
                            Specify a <form> <filter> form specific filter.
    
    complete. 0 nodes in 3 ms (0/sec).


**Examples:**

TBD

.. _storm-iden:

iden
----

The ``iden`` command lifts one or more nodes by their node identifier (node ID / iden).

**Syntax:**



.. parsed-literal::

    cli> storm iden --help
    
    usage: iden [-h] [iden [iden ...]]
    
        Lift nodes by iden.
    
        Example:
    
            iden b25bc9eec7e159dce879f9ec85fb791f83b505ac55b346fcb64c3c51e98d1175 | count
        
    
    positional arguments:
      iden        Iden to lift nodes by. May be specified multiple times.
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 3 ms (0/sec).


**Example:**

*Lift the node with node ID d7fb3ae625e295c9279c034f5d91a7ad9132c79a9c2b16eecffc8d1609d75849:*


.. parsed-literal::

    iden d7fb3ae625e295c9279c034f5d91a7ad9132c79a9c2b16eecffc8d1609d75849


**Usage Notes:**

- The node ID (iden) for a given node can be obtained by lifting the node using the ``--raw`` option to the :ref:`syn-storm` command:

  - ``storm --raw inet:fqdn=woot.com``

.. _storm-limit:

limit
-----

The ``limit`` command restricts the number of nodes returned from a given Storm query to the specified number of nodes.

**Syntax:**


.. parsed-literal::

    cli> storm limit --help
    
    usage: limit [-h] count
    
        Limit the number of nodes generated by the query in the given position.
    
        Example:
    
            inet:ipv4 | limit 10
        
    
    positional arguments:
      count       The maximum number of nodes to yield.
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 5 ms (0/sec).


**Example:**

*Lift ten IP address nodes:*


.. parsed-literal::

    inet:ipv4 | limit 10


**Usage Notes:**

- If the limit number specified (i.e., ``limit 100``) is greater than the total number of nodes returned from the Storm query, no limit will be applied to the resultant nodes (i.e., all nodes will be returned).
- By design, ``limit`` imposes an artificial limit on the nodes returned by a query, which may impair effective analysis of data by restricting results. As such, ``limit`` is most useful for viewing a subset of a large result set or an exemplar node for a given form.
- While ``limit`` returns a sampling of nodes, it is not statistically random for the purposes of population sampling for algorithmic use.

.. _storm-max:

max
---

The ``max`` command returns the node from a given set that contains the highest value for a specified secondary property.

**Syntax:**



.. parsed-literal::

    cli> storm max --help
    
    usage: max [-h] propname
    
        Consume nodes and yield only the one node with the highest value for a property.
    
        Examples:
    
            file:bytes +#foo.bar | max size
    
        
    
    positional arguments:
      propname
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 4 ms (0/sec).


**Examples:**

*Return the DNS A record for woot.com with the most recent .seen value:*


.. parsed-literal::

    inet:dns:a:fqdn=woot.com | max .seen


*Return the most recent WHOIS record for domain woot.com:*


.. parsed-literal::

    inet:whois:rec:fqdn=woot.com | max :asof


.. _storm-min:

min
---

The ``min`` command returns the node from a given set that contains the lowest value for a specified secondary property.

**Syntax:**



.. parsed-literal::

    cli> storm min --help
    
    usage: min [-h] propname
    
        Consume nodes and yield only the one node with the lowest value for a property.
    
        Examples:
    
            file:bytes +#foo.bar | min size
    
        
    
    positional arguments:
      propname
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 2 ms (0/sec).


**Examples:**

*Return the DNS A record for woot.com with the most recent .seen value:*


.. parsed-literal::

    inet:dns:a:fqdn=woot.com | min .seen


*Return the oldest WHOIS record for domain woot.com:*


.. parsed-literal::

    inet:whois:rec:fqdn=woot.com | min :asof


.. _storm-movetag:

movetag
-------

The ``movetag`` command moves a Synapse tag and its associated tag tree from one location in a tag hierarcy to another location. It is equivalent to "renaming" a given tag and all of its subtags. Moving a tag consists of:

- Creating the new ``syn:tag`` node(s).
- Copying the definitions (``:title`` and ``:doc`` properties) from the old ``syn:tag`` node to the new ``syn:tag`` node.
- Applying the new tag(s) to the nodes with the old tag(s).

  - If the old tag(s) have associated timestamps / time intervals, they will be applied to the new tag(s).

- Deleting the old tag(s) from the nodes.
- Setting the ``:isnow`` property of the old ``syn:tag`` node(s) to reference the new ``syn:tag`` node.

  - The old ``syn:tag`` nodes are **not** deleted.
  - Once the ``:isnow`` property is set, attempts to apply the old tag will automatically result in the new tag being applied.

**Syntax:**



.. parsed-literal::

    cli> storm movetag --help
    
    usage: movetag [-h] oldtag newtag
    
        Rename an entire tag tree and preserve time intervals.
    
        Example:
    
            movetag #foo.bar #baz.faz.bar
        
    
    positional arguments:
      oldtag      The tag tree to rename.
      newtag      The new tag tree name.
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 2 ms (0/sec).


**Examples:**

*Move the tag named #research to #internal.research:*


.. parsed-literal::

    movetag #research #internal.research



.. parsed-literal::

    movetag aka.fireeye.malware aka.feye.mal


**Usage Notes:**

.. WARNING::
  ``movetag`` should be used with caution as when used incorrectly it can result in "deleted" (inadvertently moved / removed) or orphaned (inadvertently retained) tags. For example, in the second example query above, all ``aka.fireeye.malware`` tags are renamed ``aka.feye.mal``, but the tag ``aka.fireeye`` still exists and is still applied to all of the original nodes. In other words, the result of the above command will be that nodes previously tagged ``aka.fireeye.malware`` will now be tagged both ``aka.feye.mal`` **and** ``aka.fireeye``. Users may wish to test the command on sample data first to understand its effects before applying it in a live Cortex.

.. _storm-noderefs:

noderefs
--------

The ``noderefs`` command returns all nodes that are adjacent to a given set of nodes (one degree away by default). "Adjacent" means nodes whose primary or secondary properties reference either a primary or secondary property of the set of input nodes.

TBD

**Syntax:**



.. parsed-literal::

    cli> storm noderefs --help
    
    usage: noderefs [-h] [-d DEGREES] [-te] [-j] [-otf OMIT_TRAVERSAL_FORM]
                    [-ott OMIT_TRAVERSAL_TAG] [-of OMIT_FORM] [-ot OMIT_TAG] [-u]
    
        Get nodes adjacent to inbound nodes, up to n degrees away.
    
        Examples:
            The following examples show long-form options. Short form options exist and
            should be easier for regular use.
    
            Get all nodes 1 degree away from a input node:
    
                ask inet:ipv4=1.2.3.4 | noderefs
    
            Get all nodes 1 degree away from a input node and include the source node:
    
                ask inet:ipv4=1.2.3.4 | noderefs --join
    
            Get all nodes 3 degrees away from a input node and include the source node:
    
                ask inet:ipv4=1.2.3.4 | noderefs --join --degrees 3
    
            Do not include nodes of a given form in the output or traverse across them:
    
                ask inet:ipv4=1.2.3.4 | noderefs --omit-form inet:dns:a
    
            Do not traverse across nodes of a given form (but include them in the output):
    
                ask inet:ipv4=1.2.3.4 | noderefs --omit-traversal-form inet:dns:a
    
            Do not include nodes with a specific tag in the output or traverse across them:
    
                ask inet:ipv4=1.2.3.4 | noderefs --omit-tag omit.nopiv
    
            Do not traverse across nodes with a sepcific tag (but include them in the output):
    
                ask inet:ipv4=1.2.3.4 | noderefs --omit-traversal-tag omit.nopiv
    
            Accept multiple inbound nodes, and unique the output set of nodes across all input nodes:
    
                ask inet:ipv4=1.2.3.4 inet:ipv4=1.2.3.5 | noderefs --degrees 4 --unique
    
        
    
    optional arguments:
      -h, --help            show this help message and exit
      -d DEGREES, --degrees DEGREES
                            Number of degrees to traverse from the source node.
      -te, --traverse-edge  Traverse Edge type nodes, if encountered, to the
                            opposite side of them, if the opposite side has not
                            yet been encountered.
      -j, --join            Include source nodes in the output of the refs
                            command.
      -otf OMIT_TRAVERSAL_FORM, --omit-traversal-form OMIT_TRAVERSAL_FORM
                            Form to omit traversal of. Nodes of forms will still
                            be the output.
      -ott OMIT_TRAVERSAL_TAG, --omit-traversal-tag OMIT_TRAVERSAL_TAG
                            Tags to omit traversal of. Nodes with these tags will
                            still be in the output.
      -of OMIT_FORM, --omit-form OMIT_FORM
                            Forms which will not be included in the output or
                            traversed.
      -ot OMIT_TAG, --omit-tag OMIT_TAG
                            Forms which have these tags will not not be included
                            in the output or traversed.
      -u, --unique          Unique the output across ALL input nodes, instead of
                            each input node at a time.
    
    complete. 0 nodes in 3 ms (0/sec).


**Examples:**

TBD

.. _storm-reindex:

reindex
-------

The ``reindex`` command reindexes a given node property. This is an administrative command that is typically used when data model updates have been pushed to a Cortex and existing node properties must be migrated to the new model.

**Syntax:**


.. parsed-literal::

    cli> storm reindex --help
    
    usage: reindex [-h] [--type TYPE] [--subs] [--form-counts]
    
        Use admin privileges to re index/normalize node properties.
    
        Example:
    
            foo:bar | reindex --subs
    
            reindex --type inet:ipv4
    
        NOTE: This is mostly for model updates and migrations.
              Use with caution and be very sure of what you are doing.
        
    
    optional arguments:
      -h, --help     show this help message and exit
      --type TYPE    Re-index all properties of a specified type.
      --subs         Re-parse and set sub props.
      --form-counts  Re-calculate all form counts.
    
    complete. 0 nodes in 2 ms (0/sec).


**Examples:**

TBD

.. _storm-sleep:

sleep
-----

The ``sleep`` command adds a delay in returning each result for a given Storm query. By default, query results are streamed back and displayed as soon as they arrive for optimal performance. A ``sleep`` delay effectively slows the display of results.

**Syntax:**


.. parsed-literal::

    cli> storm sleep --help
    
    usage: sleep [-h] delay
    
        Introduce a delay between returning each result for the storm query.
    
        NOTE: This is mostly used for testing / debugging.
    
        Example:
    
            #foo.bar | sleep 0.5
    
        
    
    positional arguments:
      delay       Delay in floating point seconds.
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 3 ms (0/sec).


**Example:**

*Retrieve domain nodes from a Cortex every second:*


.. parsed-literal::

    inet:email | sleep 1.0


.. _storm-spin:

spin
----

The ``spin`` command is used to suppress the output of a Storm query. ``Spin`` simply consumes all nodes sent to the command, so no nodes are output to the CLI. This allows you to execute a Storm query and view messages and results without displaying the associated nodes.

**Syntax:**



.. parsed-literal::

    cli> storm spin --help
    
    usage: spin [-h]
    
        Iterate through all query results, but do not yield any.
        This can be used to operate on many nodes without returning any.
    
        Example:
    
            foo:bar:size=20 [ +#hehe ] | spin
    
        
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 2 ms (0/sec).


**Examples:**

*Count the number of email addresses in a Cortex without displaying the inet:email nodes:*


.. parsed-literal::

    inet:email | count | spin


*Add the tag #int.research to any domain containing the string "firefox" but do not display the nodes.*


.. parsed-literal::

    inet:fqdn~=firefox [+#int.research] | spin


.. _storm-sudo:

sudo
----

The ``sudo`` command executes a Storm query with elevated privileges. The Synapse permissions system <link> can be used to grant or restrict permissions to users and groups.

As a best practice, we strongly recommend restricting potentially dangerous Storm operations (e.g., :ref:`storm-movetag` or :ref:`storm-delnode`) and requiring the use of ``sudo`` to perform these actions.

**Syntax:**



.. parsed-literal::

    cli> storm sudo --help
    
    usage: sudo [-h]
    
        Use admin privileges to bypass standard query permissions.
    
        Example:
    
            sudo | [ inet:fqdn=vertex.link ]
        
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 2 ms (0/sec).


**Example:**

*Delete a node using elevated privileges:*


.. parsed-literal::

    sudo | inet:fqdn=mydomain.com | delnode


.. _storm-uniq:

uniq
----

The ``uniq`` command removes duplicate results from a Storm query. Results are uniqued based on each node's node identifier (node ID / iden) so that only the first node with a given node ID is returned.

**Syntax:**


.. parsed-literal::

    cli> storm uniq --help
    
    usage: uniq [-h]
    
        Filter nodes by their uniq iden values.
        When this is used a Storm pipeline, only the first instance of a
        given node is allowed through the pipeline.
    
        Examples:
    
            #badstuff +inet:ipv4 ->* | uniq
    
        
    
    optional arguments:
      -h, --help  show this help message and exit
    
    complete. 0 nodes in 3 ms (0/sec).


**Examples:**

*Lift all of the unique IP addresses that domains associated with the Fancy Bear threat group have resolved to:*


.. parsed-literal::

    inet:fqdn#aka.threatconnect.thr.fancybear -> inet:dns:a -> inet:ipv4 | uniq

